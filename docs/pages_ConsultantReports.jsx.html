<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: pages/ConsultantReports.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: pages/ConsultantReports.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { auth } from '../firebase/firebaseConfig';
import { useEffect, useState } from 'react';
import { useAuth } from '../hooks/useAuth';
import { useFetch } from '../hooks/useFetch';
import { normalizeFileData } from '../helpers/normalizeFileData';
import { Disease } from '../components/Disease';
import '../components/List.css';

/**
 * ConsultantReports component.
 *
 * Página del rol Consultor dedicada a la
 * visualización y gestión de reportes.
 *
 * @component
 * @returns {JSX.Element}
 */

export const ConsultantReports = () => {
    const { user } = useAuth();
    const { fetchData, loading, error, setError } = useFetch();
    const backendUrl = import.meta.env.VITE_BACKEND_URL;
    const diseaseUrl = import.meta.env.VITE_API_DISEASE_URL;
    const [showDiseasePopup, setShowDiseasePopup] = useState(false);
    const [productores, setProductores] = useState([]);
    const [selectedProducer, setSelectedProducer] = useState('');
    const [reports, setReports] = useState([]);
    const [disease, setDisease] = useState(null);

  // Obtener productores del asesor
  useEffect(() => {
    const getProductores = async () => {
      if (!user?.uid) return;
      try {
        const token = await auth.currentUser?.getIdToken();
        const response = await fetchData(
          `${backendUrl}/consultant/producers/${user.uid}`,
          'GET',
          null,
          token
        );
        setProductores(response.data || []);
      } catch (err) {
        setError('Error al obtener productores');
      }
    };
    getProductores();
  }, [user]);

  // Obtener reportes del productor seleccionado
  const fetchReports = async () => {
    if (!selectedProducer) return;
    try {
      const token = user.token || await auth.currentUser?.getIdToken();
      const response = await fetchData(
        `${backendUrl}/consultant/reports/getAll/${selectedProducer}`,
        'GET',
        null,
        token
      );

      const reportsData = Array.isArray(response.data)
        ? response.data
        : response.data
        ? [response.data]
        : [];

      const normalizedReports = reportsData.map(report => ({
        ...report,
        attached: normalizeFileData(report.attached)
      }));

      setReports(normalizedReports);
    } catch (err) {
      setError('Error al obtener los reportes');
    }
  };

  const sortedReports = [...reports].sort((a, b) => {
    if (!a.created_at || !b.created_at) return 0;
    return new Date(b.created_at) - new Date(a.created_at);
  });

  const handleDownload = async (id) => {
    try {
      const token = user.token || await auth.currentUser?.getIdToken();
      const res = await fetch(`${backendUrl}/producer/reports/download/${id}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
      });

      if (!res.ok) throw new Error('Error al descargar el reporte');

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_${id}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

    } catch (error) {
      console.log('ERROR:', error);
      alert(error);
    }
  };

  const handleDisease = async (url) => {
    console.log("Entra &lt;============================>")
    try {
        const res = await fetchData(`${diseaseUrl}/analyze`, 'POST', { image_url: url });
        console.log(res, "RESPUESTA DEL FETCH")
        setDisease(res);
        setShowDiseasePopup(true);
    } catch (error) {
      console.log('ERROR:', error);
      alert(error);
    }
  };

  const handleSelectChange = (e) => {
    setSelectedProducer(e.target.value);
  };

  const handleSearch = (e) => {
    e.preventDefault();
    fetchReports();
  };

  return (
    &lt;section className='page-container'>
      &lt;div>
        &lt;h1 className='centeredText text-green'>Mis reportes&lt;/h1>
        {loading &amp;&amp; &lt;p>Cargando...&lt;/p>}
        {error &amp;&amp; &lt;p className='errorMessage'>{error}&lt;/p>}

        {/* SELECT DE PRODUCTORES */}
        &lt;h2>Productores&lt;/h2>
        &lt;form className='report-form' onSubmit={handleSearch}>
          &lt;select value={selectedProducer} onChange={handleSelectChange}>
            &lt;option value=''>Selecciona un productor&lt;/option>
            {productores.map((producer) => (
              &lt;option key={producer.email_user} value={producer.email_user}>
                {producer.name_user} ({producer.email_user})
              &lt;/option>
            ))}
          &lt;/select> 
          &lt;button className="login-button"type='submit' disabled={!selectedProducer}>Ver reportes&lt;/button>
        &lt;/form>

        &lt;ul className='report-list'>
          {sortedReports.map((report) => (
            &lt;li className='report-list-item' key={report.uid_report}>
              &lt;div>Parcela: {report.uid_parcel}&lt;/div>
              &lt;div>Para: {report.email_receiver}&lt;/div>
              &lt;div>Mensaje: {report.content_message}&lt;/div>

              {report.attached &amp;&amp; report.attached.length > 0 &amp;&amp; (
                &lt;div>Archivos adjuntos ({report.attached.length}):
                  &lt;ul>
                    {report.attached.map((fileUrl, index) => (
                      &lt;li key={index}>
                        &lt;a href={fileUrl} target='_blank' rel='noopener noreferrer'>
                          Archivo {index + 1}
                        &lt;/a>
                        &lt;button className='api-btn' onClick={() => handleDisease(fileUrl)}>
                          Predicción enfermedades
                        &lt;/button>
                      &lt;/li>
                    ))}
                  &lt;/ul>
                &lt;/div>
              )}

              &lt;div className='report-actions'>
                &lt;button className='download-btn' onClick={() => handleDownload(report.uid_report)}>
                  Descargar
                &lt;/button>
              &lt;/div>
            &lt;/li>
          ))}
        &lt;/ul>
      &lt;/div>
        {showDiseasePopup &amp;&amp; disease &amp;&amp; (
        &lt;Disease setShowDiseasePopup= {setShowDiseasePopup} disease={disease} />
        )}
    &lt;/section>
  );
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-contexts_AuthProvider.html">contexts/AuthProvider</a></li><li><a href="module-helpers_firebaseErrorMessages.html">helpers/firebaseErrorMessages</a></li><li><a href="module-hooks_useFetch.html">hooks/useFetch</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AddParcel">AddParcel</a></li><li><a href="global.html#AdminDashboard">AdminDashboard</a></li><li><a href="global.html#AdminLayout">AdminLayout</a></li><li><a href="global.html#AdminNav">AdminNav</a></li><li><a href="global.html#AdminUserEdit">AdminUserEdit</a></li><li><a href="global.html#AdminUsers">AdminUsers</a></li><li><a href="global.html#AnalystDashboard">AnalystDashboard</a></li><li><a href="global.html#AnalystLayout">AnalystLayout</a></li><li><a href="global.html#AnaystNav">AnaystNav</a></li><li><a href="global.html#AppRoutes">AppRoutes</a></li><li><a href="global.html#AuthContext">AuthContext</a></li><li><a href="global.html#AuthLayout">AuthLayout</a></li><li><a href="global.html#ChatBot">ChatBot</a></li><li><a href="global.html#ClickablePolygon">ClickablePolygon</a></li><li><a href="global.html#ConsultantDashboard">ConsultantDashboard</a></li><li><a href="global.html#ConsultantFields">ConsultantFields</a></li><li><a href="global.html#ConsultantLayout">ConsultantLayout</a></li><li><a href="global.html#ConsultantNav">ConsultantNav</a></li><li><a href="global.html#ConsultantReports">ConsultantReports</a></li><li><a href="global.html#ConsultantSeeProducerFields">ConsultantSeeProducerFields</a></li><li><a href="global.html#DirectorConsultants">DirectorConsultants</a></li><li><a href="global.html#DirectorDashboard">DirectorDashboard</a></li><li><a href="global.html#DirectorFields">DirectorFields</a></li><li><a href="global.html#DirectorLayout">DirectorLayout</a></li><li><a href="global.html#DirectorNav">DirectorNav</a></li><li><a href="global.html#DirectorReports">DirectorReports</a></li><li><a href="global.html#Disease">Disease</a></li><li><a href="global.html#DistributorDashboard">DistributorDashboard</a></li><li><a href="global.html#DistributorLayout">DistributorLayout</a></li><li><a href="global.html#DistributorNav">DistributorNav</a></li><li><a href="global.html#FieldInfo">FieldInfo</a></li><li><a href="global.html#FilterParcelForm">FilterParcelForm</a></li><li><a href="global.html#Legend">Legend</a></li><li><a href="global.html#LoginPage">LoginPage</a></li><li><a href="global.html#Map">Map</a></li><li><a href="global.html#MapsContext">MapsContext</a></li><li><a href="global.html#MenuCard">MenuCard</a></li><li><a href="global.html#NavContext">NavContext</a></li><li><a href="global.html#ParcelDetails">ParcelDetails</a></li><li><a href="global.html#PrivateRoutes">PrivateRoutes</a></li><li><a href="global.html#ProducerDashboard">ProducerDashboard</a></li><li><a href="global.html#ProducerLayout">ProducerLayout</a></li><li><a href="global.html#ProducerNav">ProducerNav</a></li><li><a href="global.html#ProducerReports">ProducerReports</a></li><li><a href="global.html#ProducerSeeFields">ProducerSeeFields</a></li><li><a href="global.html#Report">Report</a></li><li><a href="global.html#VegetationIndex">VegetationIndex</a></li><li><a href="global.html#ViewerParcelProducer">ViewerParcelProducer</a></li><li><a href="global.html#ViewerPopup">ViewerPopup</a></li><li><a href="global.html#firebaseConfig">firebaseConfig</a></li><li><a href="global.html#normalizeFileData">normalizeFileData</a></li><li><a href="global.html#options">options</a></li><li><a href="global.html#useAuth">useAuth</a></li><li><a href="global.html#useChatSocket">useChatSocket</a></li><li><a href="global.html#useNav">useNav</a></li><li><a href="global.html#userMap">userMap</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Thu Jan 29 2026 15:34:36 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
