<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: hooks/userMap.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: hooks/userMap.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { useCallback, useContext } from "react"
import { MapsContext } from "../contexts/MapsContext"
import {useFetch} from './useFetch'
import { useAuth } from "./useAuth";
import { auth } from '../firebase/firebaseConfig';

/**
 * Hook de servicios para la gestión de datos geoespaciales y meteorológicos.
 * 
 * Proporciona métodos para interactuar con la API de datos agrícolas (Sentinel),
 * servicios meteorológicos y la persistencia de parcelas en el backend.
 * 
 * @function userMap
 * @category Hooks
 * @returns {Object} Funciones de gestión de parcelas, alertas y mapas de salud.
 */
export const userMap = () => { 
    const { user } = useAuth();
     const { fetchData, loading, error, setError } = useFetch();
     const backendUrl = import.meta.env.VITE_BACKEND_URL;
     const apiDataUrl = import.meta.env.VITE_API_DATA_URL
    

    /**
     * Obtiene información meteorológica detallada de una parcela específica.
     * @async
     * @param {string} uid_parcel - Identificador único de la parcela.
     * @returns {Promise&lt;Object|undefined>} Datos meteorológicos o undefined si falla.
     */
      const getInfoMeteoByParcel = async (uid_parcel) => {
        if(!uid_parcel) return
        try {
             const firebaseUser = auth.currentUser;
                    if (!firebaseUser) {
                      console.error('No hay usuario autenticado en Firebase');
                      return;
                    }
                    
                    const token = await firebaseUser.getIdToken();
                    // console.log('llamada')
                    const response = await fetchData(
                      `${backendUrl}/alerts/getInfoMeteoByParcel/${uid_parcel}`,
                      'GET',
                      null,
                      token
                    );
                    
                    console.log('Datos meteorológicos de la parcela seleccionada:', response);
                    return response
                } catch (error) {
                    setError('Error al cargar los datos de las parcela')        }
      }

      const getAllInfoMeteoByUser = async (email) => {
        if(!email) return
        try {
             const firebaseUser = auth.currentUser;
                    if (!firebaseUser) {
                      console.error('No hay usuario autenticado en Firebase');
                      return;
                    }
                    
                    const token = await firebaseUser.getIdToken();
                    // console.log('llamada')
                    const response = await fetchData(
                      `${backendUrl}/alerts/getAllInfoMeteoByUser/${email}`,
                      'GET',
                      null,
                      token
                    );
                    
                    console.log('Datos meteorológicos de tus parcelas', response);
                    return response
                } catch (error) {
                    setError('Error al cargar los datos de la parcela')        }
      }

/**
 * Obtiene todas las alertas climáticas asociadas a un usuario por su email.
 * @async
 * @param {string} email - Email del usuario.
 * @returns {Promise&lt;Array|undefined>} Listado de alertas activas.
 */
const getAllAlertsByUser = useCallback(async (email) => {
    if(!email) return;
    try {
      const firebaseUser = auth.currentUser;
      if (!firebaseUser) return;
      const token = await firebaseUser.getIdToken();

      const response = await fetchData(
        `${backendUrl}/alerts/getAllAlertsByUser/${email}`,
        'GET',
        null,
        token
      );

      console.log('Estas son las alertas de tus parcelas', response);
      return response;
    } catch (error) {
      setError('Error al cargar las alertas de la parcela');
    }
  }, [fetchData, setError, backendUrl]);

  const getAllAlertByUid = useCallback(async (uid_parcel) => {
    if(!uid_parcel) return;
    try {
      const firebaseUser = auth.currentUser;
      if (!firebaseUser) return;
      const token = await firebaseUser.getIdToken();

      const response = await fetchData(
        `${backendUrl}/getAlertByParcel/${uid_parcel}`,
        'GET',
        null,
        token
      );

      console.log(`esta es la alerta de la parcela con uid ${uid_parcel}`, response);
      return response;
    } catch (error) {
      setError('Error al cargar las alertas de la parcela');
    }
  }, [fetchData, setError, backendUrl]);
      
       const getAlertByParcel = async (uid_parcel) => {
        if(!uid_parcel) return
        try {
             const firebaseUser = auth.currentUser;
                    if (!firebaseUser) {
                      console.error('No hay usuario autenticado en Firebase');
                      return;
                    }
                    
                    const token = await firebaseUser.getIdToken();
                    // console.log('llamada')
                    const response = await fetchData(
                      `${backendUrl}/alerts/getAlertByParcel/${uid_parcel}`,
                      'GET',
                      null,
                      token
                    );
                    
                    console.log('Alertas de la parcela seleccionada:', response);
                    return response
                } catch (error) {
                    setError('Error al cargar las  alertas de las parcela')        }
      }

      
    /**
     * Solicita a la API externa el procesamiento de alertas para una nueva parcela.
     * @async
     * @param {string} uid_parcel - Identificador único de la parcela.
     * @returns {Promise&lt;string|undefined>} 'OK' si el proceso de guardado fue exitoso.
     */
      const saveAlertsByParcel = async (uid_parcel) => {
        if(!uid_parcel) return
        try {
          console.log('LLAMANDO A LA TIERRA, ESPERANDO CONTESTACIÓN &lt;==============================>');
          const body = {uid_parcela: uid_parcel}
          // console.log('llamada')
          const response = await fetchData(
          
            `${apiDataUrl}/alertas_tiempo_parcela`,
            'POST',
            body,
            null
          );
          if(response === 'OK') {
            console.log('Se han guardado las alertas de la parcela creada:', response);
            console.log('RESPUESTA CORRECETA PABLO &lt;==============================>');
                return response
          } else {
            setError("No Se ha podido guardar las alertas de la parcela creada")
            console.log('Problemas en guardar alertas en la parcela creada')
            return 
          }
            } catch (error) {
              console.log(error, 'Error al guardar las  alertas de las parcela')
                setError('Error al guardar las  alertas de las parcela')        }
      }

    /**
     * Obtiene las URLs de las imágenes PNG (Sentinel-2) que representan la salud del campo.
     * @async
     * @param {string} uid_parcel - Identificador único de la parcela.
     * @returns {Promise&lt;Object|undefined>} Objeto con rutas a imágenes de índices de vegetación.
     */
      const HealthMap = async (uid_parcel) => {
        if(!uid_parcel) return
        try {
            const body = {uid_parcel}
            const response = await fetchData(
                `${apiDataUrl}/maps_sentinel`,
                'POST',
                body,
                null
                );
                    
                    console.log('Estos son los png de la salud del campo:', response);
                    return response
                } catch (error) {
                    setError('Error al cargar las  alertas de las parcela')    
                }
      }
    /**
     * Registra una nueva parcela en la API de procesamiento de datos geoespaciales.
     * @async
     * @param {string} nombrecampo - Alias o nombre de la parcela.
     * @param {Object} shape - Objeto GeoJSON o estructura de coordenadas de la parcela.
     * @returns {Promise&lt;Object|undefined>} Respuesta de confirmación de la API de datos.
     */
      const addParcelApi = async (nombrecampo, shape) => {
        if(!nombrecampo || !shape) return
        try {
                              
            const body = {nombrecampo, shape}
                const response = await fetchData(
                    `${apiDataUrl}/agregarlote`,
                    'POST',
                    body,
                    null
                    );
                    
                    console.log('respuesta al crear parcela', response);
                    return response

                } catch (error) {
                  console.log(error)
                    setError('Error al crear la parcela')    
                }
      }
    /**
     * Persiste la creación de una parcela en el backend propio, incluyendo metadatos y fotografía.
     * Utiliza `FormData` para el envío de archivos multimedia.
     * 
     * @async
     * @param {string} uid_parcel - UID generado para la parcela.
     * @param {string} uid_producer - UID del productor propietario.
     * @param {string} name_parcel - Nombre descriptivo.
     * @param {number} id_cultivo - ID del tipo de cultivo seleccionado.
     * @param {Array} coordinates_parcel - Array de coordenadas geográficas.
     * @param {File|null} photo - Archivo de imagen de la parcela.
     * @returns {Promise&lt;Object>} Respuesta del servidor backend.
     */
      const createParcel = async (uid_parcel, uid_producer,name_parcel,id_cultivo,coordinates_parcel, photo) => {
        
          try {
            const firebaseUser = auth.currentUser;

            if (!firebaseUser) {
              throw new Error('No hay usuario autenticado en Firebase');
            }

            const token = await firebaseUser.getIdToken();

            const formData = new FormData();
            formData.append('uid_parcel', uid_parcel);
            formData.append('uid_producer', uid_producer);
            formData.append('name_parcel', name_parcel);
            formData.append('id_cultivo', id_cultivo);
            formData.append('coordinates_parcel', JSON.stringify(coordinates_parcel));
            if (photo) formData.append('photo', photo);
          console.log('entra en create Parcel', {formData})
            const response = await fetch(`${backendUrl}/producer/createParcel`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: formData,
            });

            // console.log(response, 'create parcels');

            // if (!response.ok) {
            //   let errorMsg = 'Error al crear parcela';
            //   try {
            //     const err = await response.json();
            //     errorMsg = err.msg || errorMsg;
            //   } catch (_) {}
            //   throw new Error(errorMsg);
            // }
            
            return await response.json();

          } catch (error) {
            console.error('createParcel error:', error);
            throw error; 
          }
        };


      const deleteParcelApi = async (uid_parcel) => {
       
        try {
            const firebaseUser = auth.currentUser;
                 if (!firebaseUser) {
                   console.error('No hay usuario autenticado en Firebase');
                  return;
                 }                   
            
            const response = await fetchData(`${apiDataUrl}/eliminarlote?lote=${uid_parcel}`)          
                  console.log('llamada a la api para eliminar parcela', response);
                  return response

         } catch (error) {
             setError('Error al elimminar la parcela')    
         }
      }

      const deleteParcelBack = async (uid_parcel) => {
        try {
            const firebaseUser = auth.currentUser;
                 if (!firebaseUser) {
                   console.error('No hay usuario autenticado en Firebase');
                  return;
                 }
                    
                 const token = await firebaseUser.getIdToken();
                    
            
            const response = await fetchData(`${backendUrl}/producer/deleteParcel/${uid_parcel}`,
                                              'DELETE',
                                              null,
                                              token
                                            )
                    
                  console.log('llamada al back para eliminar parcela', response);
                  return response

         } catch(error) {
              console.log(error)
              return error
         }
      }

      const bboxCenter = (polygons) =>{
          
       if (polygons.length=== 0) return
        let minLat = Infinity, maxLat = -Infinity;
        let minLng = Infinity, maxLng = -Infinity;

        polygons.forEach(polygon => {
            polygon.forEach(([lat, lng]) => {
            minLat = Math.min(minLat, lat);
            maxLat = Math.max(maxLat, lat);
            minLng = Math.min(minLng, lng);
            maxLng = Math.max(maxLng, lng);
            });
        });
        const centro = [
            (minLat + maxLat) / 2,
            (minLng + maxLng) / 2   
        ];
         return centro
    }

    const getParcelVegetation = async (uid_parcel) => {
      if(!uid_parcel) return
        try {
             const firebaseUser = auth.currentUser;
                    if (!firebaseUser) {
                      console.error('No hay usuario autenticado en Firebase');
                      return;
                    }
                    
                    const token = await firebaseUser.getIdToken();
                    // console.log('llamada')
                    const response = await fetchData(
                      `${backendUrl}/alerts/getParcelVegetation/${uid_parcel}`,
                      'GET',
                      null,
                      token
                    );
                    
                    console.log('Vegetación de la parcela seleccionada:', response);
                    return response
                } catch (error) {
                    setError('Error al cargar lavegetación parcela')        
                }
    }

    const getParcelCrops = useCallback(async (uid_parcel) => {
      if(!uid_parcel) return
        try {
             const firebaseUser = auth.currentUser;
                    if (!firebaseUser) {
                      console.error('No hay usuario autenticado en Firebase');
                      return;
                    }
                    
                    const token = await firebaseUser.getIdToken();
                    // console.log('llamada')
                    const response = await fetchData(
                      `${backendUrl}/alerts/getParcelCrops/${uid_parcel}`,
                      'GET',
                      null,
                      token
                    );
                    
                    console.log('Tipo de cultivo de la parcela seleccionada:', response);
                    return response
                } catch (error) {
                    setError('Error al cargar el tipo de cultivo parcela')        }
    })
    


      
    
    return {
        getInfoMeteoByParcel,
        getAlertByParcel,
        getAllAlertsByUser,
        getAllInfoMeteoByUser,
        HealthMap,
        addParcelApi,
        createParcel,
        deleteParcelApi,
        deleteParcelBack,
        bboxCenter,
        getAlertByParcel,
        getParcelVegetation,
        getParcelCrops,
        saveAlertsByParcel
        }

    
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-contexts_AuthProvider.html">contexts/AuthProvider</a></li><li><a href="module-helpers_firebaseErrorMessages.html">helpers/firebaseErrorMessages</a></li><li><a href="module-hooks_useFetch.html">hooks/useFetch</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AddParcel">AddParcel</a></li><li><a href="global.html#AdminDashboard">AdminDashboard</a></li><li><a href="global.html#AdminLayout">AdminLayout</a></li><li><a href="global.html#AdminNav">AdminNav</a></li><li><a href="global.html#AdminUserEdit">AdminUserEdit</a></li><li><a href="global.html#AdminUsers">AdminUsers</a></li><li><a href="global.html#AnalystDashboard">AnalystDashboard</a></li><li><a href="global.html#AnalystLayout">AnalystLayout</a></li><li><a href="global.html#AnaystNav">AnaystNav</a></li><li><a href="global.html#AppRoutes">AppRoutes</a></li><li><a href="global.html#AuthContext">AuthContext</a></li><li><a href="global.html#AuthLayout">AuthLayout</a></li><li><a href="global.html#ChatBot">ChatBot</a></li><li><a href="global.html#ClickablePolygon">ClickablePolygon</a></li><li><a href="global.html#ConsultantDashboard">ConsultantDashboard</a></li><li><a href="global.html#ConsultantFields">ConsultantFields</a></li><li><a href="global.html#ConsultantLayout">ConsultantLayout</a></li><li><a href="global.html#ConsultantNav">ConsultantNav</a></li><li><a href="global.html#ConsultantReports">ConsultantReports</a></li><li><a href="global.html#ConsultantSeeProducerFields">ConsultantSeeProducerFields</a></li><li><a href="global.html#DirectorConsultants">DirectorConsultants</a></li><li><a href="global.html#DirectorDashboard">DirectorDashboard</a></li><li><a href="global.html#DirectorFields">DirectorFields</a></li><li><a href="global.html#DirectorLayout">DirectorLayout</a></li><li><a href="global.html#DirectorNav">DirectorNav</a></li><li><a href="global.html#DirectorReports">DirectorReports</a></li><li><a href="global.html#Disease">Disease</a></li><li><a href="global.html#DistributorDashboard">DistributorDashboard</a></li><li><a href="global.html#DistributorLayout">DistributorLayout</a></li><li><a href="global.html#DistributorNav">DistributorNav</a></li><li><a href="global.html#FieldInfo">FieldInfo</a></li><li><a href="global.html#FilterParcelForm">FilterParcelForm</a></li><li><a href="global.html#Legend">Legend</a></li><li><a href="global.html#LoginPage">LoginPage</a></li><li><a href="global.html#Map">Map</a></li><li><a href="global.html#MapsContext">MapsContext</a></li><li><a href="global.html#MenuCard">MenuCard</a></li><li><a href="global.html#NavContext">NavContext</a></li><li><a href="global.html#ParcelDetails">ParcelDetails</a></li><li><a href="global.html#PrivateRoutes">PrivateRoutes</a></li><li><a href="global.html#ProducerDashboard">ProducerDashboard</a></li><li><a href="global.html#ProducerLayout">ProducerLayout</a></li><li><a href="global.html#ProducerNav">ProducerNav</a></li><li><a href="global.html#ProducerReports">ProducerReports</a></li><li><a href="global.html#ProducerSeeFields">ProducerSeeFields</a></li><li><a href="global.html#Report">Report</a></li><li><a href="global.html#VegetationIndex">VegetationIndex</a></li><li><a href="global.html#ViewerParcelProducer">ViewerParcelProducer</a></li><li><a href="global.html#ViewerPopup">ViewerPopup</a></li><li><a href="global.html#firebaseConfig">firebaseConfig</a></li><li><a href="global.html#normalizeFileData">normalizeFileData</a></li><li><a href="global.html#options">options</a></li><li><a href="global.html#useAuth">useAuth</a></li><li><a href="global.html#useChatSocket">useChatSocket</a></li><li><a href="global.html#useNav">useNav</a></li><li><a href="global.html#userMap">userMap</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Thu Jan 29 2026 15:34:36 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
